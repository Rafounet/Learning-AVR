#define F_CPU 16000000 // Clock speed 16MHz

#include <avr/io.h> 
#include <avr/interrupt.h>
#include <util/delay.h>
#include <stdbool.h>
#define BAUD 9600
#define MYUBRR F_CPU/16/BAUD-1
#define led _BV(PB5)
#define bot _BV(PD2)

volatile char rx;
volatile bool e;
void send_char(char c);
void send_string(char s[]);

int main (void) {
	DDRB |= led;
	DDRD &= ~bot;
	PORTD |= _BV(PORTD2);
	cli(); // Disable interrupts
	UBRR0H = (MYUBRR >> 8);  // Set baud rate
  	UBRR0L = MYUBRR;			 // ||   ||   ||
   
  	UCSR0B |= _BV(RXEN0) | _BV(TXEN0); // Enable USART receiver and transmitter
  	UCSR0C |= _BV(UCSZ01) | _BV(UCSZ00); // Set frame: 8data, 1stop bit
	UCSR0B |= _BV(RXCIE0); // Enable RX interrupt
	
	EICRA |= _BV(ISC01);
	EIMSK |= _BV(INT0);
	
	PORTB &= ~led;
	sei(); // Enable interrupts
   while(1){
   	if(e){
   		cli();
			if(PORTB != 0b00100000){ // if rx = "1"
   			send_string("1");
   			send_char(0xa); // New line
   			PORTB |= led; // Turn on PB5
   		}
   		else if(PORTB == 0b00100000){ // if rx = "0"
   			send_string("0");
   			send_char(0xa); // New line
   			PORTB &= ~led; // Turn off PB5
   		}
   		sei();
   		e = false;	
   	}
   } 
}

ISR (USART_RX_vect){ // Receive interrupt
	rx = UDR0;
	if(rx==0x31){ // if rx = "1"
   	send_string("on");
   	send_char(0xa); // New line
   	PORTB |= led; // Turn on PB5
   }
   else if(rx==0x30){ // if rx = "0"
   	send_string("off");
   	send_char(0xa); // New line
   	PORTB &= ~led; // Turn off PB5
   }
   else if(rx==0x23){ // #
   	PORTB ^= led;
   	_delay_ms(200);
   	PORTB ^= led;
   	_delay_ms(200);
   	PORTB ^= led;
   	_delay_ms(200);
   	PORTB ^= led;
   	_delay_ms(200);
   }
}

ISR (INT0_vect){
	_delay_ms(300);
	e = true;
}

void send_char(char c){
	while((UCSR0A & _BV(UDRE0)) == 0){} // Wait UDR0
	UDR0 = c;
}

void send_string(char s[]){
	int i = 0;
	while(s[i] != 0b00000000) {
		send_char(s[i]);
		i++;
	}
}
